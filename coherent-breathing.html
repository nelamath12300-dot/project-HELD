<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coherent Breathing</title>

<style>
body{
  margin:0;
  background:#097275;
  color:#e5e7ff;
  font-family:"Playfair Display", serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

/* BACK BUTTON */
.back-wrap{
  position:fixed;
  top:18px;
  left:18px;
  font-family: Inter, system-ui;
  font-weight:600;
  cursor:pointer;
  opacity:.9;
}
.back-wrap span{
  padding:8px 10px;
  border-radius:8px;
}
.back-wrap:hover{opacity:1}

/* LAYOUT */
.container{
  text-align:center;
  max-width:520px;
  padding:18px;
}

/* SPHERE */
.sphere{
  width:310px;
  height:310px;
  margin:40px auto 28px;
  position:relative;
  border-radius:50%;
  transform-origin:center;
  transition: transform 3.6s ease-in-out;
}

.dot{
  position:absolute;
  width:6px;
  height:6px;
  border-radius:50%;
  background:#17690c;
  opacity:.95;
  /* Smooth transition for dot movement */
  transition: all 3.6s cubic-bezier(0.4, 0, 0.2, 1);
  transform-origin:center;
}

/* TEXT */
.title{font-size:28px;margin-top:4px}
.subtitle{
  font-family: Inter;
  font-size:14px;
  opacity:.7;
  margin-bottom:22px;
}

/* BUTTON */
.begin-btn{
  margin-top:16px;
  padding:14px 22px;
  border-radius:999px;
  border:none;
  background:#ffffff;
  color:#000;
  font-weight:600;
  font-family: Inter;
  cursor:pointer;
}
.begin-btn:active{transform:scale(.97)}

/* breathing step text */
.step-text{
  margin-top:10px;
  font-size:24px;
}

/* increased settle text size */
.small-hint{
  margin-top:10px;
  font-family: Inter;
  font-size:16px;
  opacity:.85;
}

/* FEEDBACK */
.feedback{
  margin-top:26px;
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
}
.fb-btn{
  border:1px solid #777;
  background:transparent;
  color:#fff;
  padding:12px 18px;
  border-radius:999px;
  cursor:pointer;
  font-family: Inter;
}
.fb-btn:hover{background:#ffffff12}

/* Done button */
.done-btn{
  margin-top:14px;
  padding:12px 24px;
  border-radius:999px;
  border:none;
  background:#ffffff;
  color:#000;
  font-weight:600;
  font-family:Inter;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="back-wrap" onclick="location.href='breathing.html'">
  <span>← Back</span>
</div>

<div class="container" id="app">

  <div id="intro">
    <div class="sphere" id="introSphere"></div>

    <div class="title">Coherent Breathing</div>

    <div class="subtitle">
      Regulate your daily heart rate with this rhythmic breathing exercise
    </div>

    <button class="begin-btn" onclick="startSettle()">Begin</button>
  </div>

  <div id="stage" style="display:none">
    <div class="sphere" id="sphere"></div>
    <div class="step-text" id="stepLabel"></div>
    <div class="small-hint" id="hintText"></div>
  </div>

</div>

<script>
/* ---------- TIMING ---------- */
const SETTLE_DURATION = 7000; 
const INHALE_MS = 4000;
const EXHALE_MS = 4000;
const TOTAL_LOOPS = 7;

let loopCount = 0;
let currentDots = [];
let currentPositions = [];

/* ---------- SPHERE GRID ---------- */
function buildSphereGrid(el, color, scaleFactor = 1){
  el.innerHTML = "";
  const SIZE = 280;
  const cx = SIZE / 2;
  const cy = SIZE / 2;
  
  const totalDots = 350; 
  const goldenRatio = (1 + Math.sqrt(5)) / 2;

  currentDots = [];
  currentPositions = [];

  for(let i = 0; i < totalDots; i++){
    // Fibonacci Sphere Algorithm
    const y = 1 - (i / (totalDots - 1)) * 2; 
    const radiusAtY = Math.sqrt(1 - y * y); 
    const theta = 2 * Math.PI * goldenRatio * i;

    // Apply scale factor for expansion/contraction
    const radius = 140 * scaleFactor;
    
    const xPos = cx + Math.cos(theta) * radiusAtY * radius;
    const yPos = cy + y * radius;

    const dot = document.createElement("div");
    dot.className = "dot";
    dot.style.background = color;

    // Store original position for exhale calculations
    const originalPosition = {
      x: xPos,
      y: yPos,
      theta: theta,
      radiusAtY: radiusAtY,
      yPos: y
    };

    // Scale dots based on position and current scale
    const depth = 0.5 + ((y + 1) / 2) * 0.5;
    const dotSize = 4 * depth * (scaleFactor < 1 ? scaleFactor * 0.8 : scaleFactor);
    dot.style.width = dotSize + "px";
    dot.style.height = dotSize + "px";

    dot.style.left = xPos + "px";
    dot.style.top = yPos + "px";

    el.appendChild(dot);
    
    currentDots.push(dot);
    currentPositions.push(originalPosition);
  }
}

/* ---------- ANIMATE DOTS TOGETHER (Inhale) ---------- */
function animateDotsTogether(color) {
  const sphere = document.getElementById("sphere");
  const dots = currentDots;
  const centerX = 140;
  const centerY = 140;
  const gatherRadius = 60; // Smaller radius for tighter gathering
  
  dots.forEach((dot, i) => {
    // Change color
    dot.style.background = color;
    
    // Calculate position in a tight circle
    const angle = (i / dots.length) * Math.PI * 2;
    const targetX = centerX + Math.cos(angle) * gatherRadius;
    const targetY = centerY + Math.sin(angle) * gatherRadius;
    
    // Animate to gathered position
    dot.style.transition = 'all 3.6s cubic-bezier(0.4, 0, 0.2, 1)';
    dot.style.left = targetX + 'px';
    dot.style.top = targetY + 'px';
    dot.style.transform = `scale(1.4)`; // Slightly bigger when gathered
  });
  
  sphere.style.transform = "scale(1.12)";
}

/* ---------- ANIMATE DOTS SPREAD (Exhale) ---------- */
function animateDotsSpread(color) {
  const sphere = document.getElementById("sphere");
  const dots = currentDots;
  const positions = currentPositions;
  const spreadRadius = 120; // Radius for spread out position
  
  dots.forEach((dot, i) => {
    // Change color
    dot.style.background = color;
    
    // Use original Fibonacci positions but scaled down
    const pos = positions[i];
    const centerX = 140;
    const centerY = 140;
    
    const targetX = centerX + Math.cos(pos.theta) * pos.radiusAtY * spreadRadius;
    const targetY = centerY + pos.yPos * spreadRadius;
    
    // Animate back to spread position
    dot.style.transition = 'all 3.6s cubic-bezier(0.4, 0, 0.2, 1)';
    dot.style.left = targetX + 'px';
    dot.style.top = targetY + 'px';
    dot.style.transform = `scale(0.9)`; // Slightly smaller when spread
  });
  
  sphere.style.transform = "scale(0.82)";
}

/* ---------- RESET TO NEUTRAL ---------- */
function resetToNeutral(color) {
  const sphere = document.getElementById("sphere");
  const dots = currentDots;
  const positions = currentPositions;
  const neutralRadius = 120;
  
  dots.forEach((dot, i) => {
    dot.style.background = color;
    
    const pos = positions[i];
    const centerX = 140;
    const centerY = 140;
    
    const targetX = centerX + Math.cos(pos.theta) * pos.radiusAtY * neutralRadius;
    const targetY = centerY + pos.yPos * neutralRadius;
    
    dot.style.transition = 'all 2s ease-out';
    dot.style.left = targetX + 'px';
    dot.style.top = targetY + 'px';
    dot.style.transform = `scale(1)`;
  });
  
  sphere.style.transform = "scale(0.9)";
}

/* ---------- INTRO ---------- */
buildSphereGrid(document.getElementById("introSphere"),"#b9c6ff", 0.9);

/* ---------- SETTLE ---------- */
function startSettle(){
  document.getElementById("intro").style.display="none";
  document.getElementById("stage").style.display="block";

  const sphere=document.getElementById("sphere");
  buildSphereGrid(sphere,"#aebdff", 0.9);

  document.getElementById("stepLabel").innerText="Get settled";
  document.getElementById("hintText").innerText =
    "You're doing something good for yourself — stay with this moment.";

  // Gentle pulse at start
  setTimeout(() => {
    sphere.style.transform = "scale(1)";
    currentDots.forEach(dot => {
      dot.style.transform = "scale(1.1)";
    });
  }, 100);

  setTimeout(startBreathing, SETTLE_DURATION);
}

/* ---------- INHALE / EXHALE LOOP ---------- */
function startBreathing(){
  loopCount=0;
  inhale();
}

function inhale(){
  document.getElementById("stepLabel").innerText="Inhale";
  document.getElementById("hintText").innerText="Slow, gentle breath in";

  // Animate dots to gather together
  animateDotsTogether("#9fb5ff");

  setTimeout(exhale, INHALE_MS);
}

function exhale(){
  document.getElementById("stepLabel").innerText="Exhale";
  document.getElementById("hintText").innerText="Soft, easy breath out";

  // Animate dots to spread out from their current gathered position
  animateDotsSpread("#ffd98a");
  
  loopCount++;

  if(loopCount >= TOTAL_LOOPS){
    setTimeout(showComplete, EXHALE_MS);
  } else {
    setTimeout(inhale, EXHALE_MS);
  }
}

/* ---------- COMPLETION + FEEDBACK ---------- */
function showComplete(){
  document.getElementById("stepLabel").innerText="Well done";
  document.getElementById("hintText").innerText="";

  // Reset dots to neutral position
  resetToNeutral("#aebdff");

  const fb=document.createElement("div");
  fb.className="feedback";

  fb.innerHTML=`
    <button class="fb-btn" onclick="feedback('Not helpful')">
      Not helpful
    </button>
    <button class="fb-btn" onclick="feedback('A little helpful')">
      A little helpful
    </button>
    <button class="fb-btn" onclick="feedback('Very helpful')">
      Very helpful
    </button>
  `;

  document.getElementById("stage").appendChild(fb);
}

/* ---------- FEEDBACK HANDLER ---------- */
function feedback(value){
  const done=document.createElement("button");
  done.className="done-btn";
  done.innerText="Done";
  done.onclick = ()=>location.href='breathing.html';
  document.getElementById("stage").appendChild(done);
}
</script>

</body>
</html>
